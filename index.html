<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <title>Trivia VR - ESAN Final</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>
    <script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>

    <script>
      // ==========================================
      // BASE DE DATOS
      // ==========================================
      const DATABASE = {
        'ES': {
            ui: { 
                bienvenida: "BIENVENIDO", 
                subtitulo: "SEMANA INTERNACIONAL ESAN",
                instr: "SELECCIONA TU IDIOMA",
                btn_es: "ESPAÑOL", 
                btn_en: "ENGLISH",
                score: "PUNTAJE FINAL", 
                restart: "VOLVER A JUGAR",
                // Mensajes según puntaje
                msg_perfecto: "¡EXCELENTE!",
                msg_alto: "¡MUY BIEN!",
                msg_medio: "¡BIEN HECHO!",
                msg_bajo: "¡PUEDES MEJORAR!"
            },
            preguntas: [
                { q: "¿Quién descubrió América?", ops: ["Cristóbal Colón", "Américo Vespucio", "Magallanes", "Marco Polo"], ans: 0 },
                { q: "¿Cuándo comenzó la II Guerra Mundial?", ops: ["1914", "1920", "1939", "1945"], ans: 2 },
                { q: "¿Quién pintó la Mona Lisa?", ops: ["Picasso", "Van Gogh", "Da Vinci", "Miguel Ángel"], ans: 2 },
                { q: "¿Cuál es el río más largo del mundo?", ops: ["Nilo", "Amazonas", "Misisipi", "Yangtsé"], ans: 1 },
                { q: "¿En qué año llegó el hombre a la Luna?", ops: ["1950", "1969", "1980", "2000"], ans: 1 },
                { q: "¿Cuál es el país más grande del mundo?", ops: ["China", "EE.UU.", "Rusia", "Canadá"], ans: 2 },
                { q: "¿Dónde están las Pirámides de Giza?", ops: ["México", "Perú", "Egipto", "Sudán"], ans: 2 },
                { q: "¿Qué elemento químico es la H?", ops: ["Helio", "Hierro", "Hidrógeno", "Holmio"], ans: 2 },
                { q: "¿Cuál es la capital de Francia?", ops: ["Londres", "Berlín", "Roma", "París"], ans: 3 },
                { q: "¿Quién escribió Don Quijote?", ops: ["Cervantes", "Shakespeare", "Dante", "Gabo"], ans: 0 }
            ]
        },
        'EN': {
             ui: { 
                bienvenida: "WELCOME", 
                subtitulo: "ESAN INTERNATIONAL WEEK",
                instr: "SELECT YOUR LANGUAGE",
                btn_es: "SPANISH",
                btn_en: "ENGLISH",
                score: "FINAL SCORE", 
                restart: "PLAY AGAIN",
                // Messages by score
                msg_perfecto: "EXCELLENT!",
                msg_alto: "VERY GOOD!",
                msg_medio: "WELL DONE!",
                msg_bajo: "KEEP TRYING!"
            },
            preguntas: [
                { q: "Who discovered America?", ops: ["Christopher Columbus", "Amerigo Vespucci", "Magellan", "Marco Polo"], ans: 0 },
                { q: "When did WWII start?", ops: ["1914", "1920", "1939", "1945"], ans: 2 },
                { q: "Who painted the Mona Lisa?", ops: ["Picasso", "Van Gogh", "Da Vinci", "Michelangelo"], ans: 2 },
                { q: "What is the longest river in the world?", ops: ["Nile", "Amazon", "Mississippi", "Yangtze"], ans: 1 },
                { q: "What year did man land on the Moon?", ops: ["1950", "1969", "1980", "2000"], ans: 1 },
                { q: "What is the largest country in the world?", ops: ["China", "USA", "Russia", "Canada"], ans: 2 },
                { q: "Where are the Pyramids of Giza?", ops: ["Mexico", "Peru", "Egypt", "Sudan"], ans: 2 },
                { q: "What chemical element is H?", ops: ["Helium", "Iron", "Hydrogen", "Holmium"], ans: 2 },
                { q: "What is the capital of France?", ops: ["London", "Berlin", "Rome", "Paris"], ans: 3 },
                { q: "Who wrote Don Quixote?", ops: ["Cervantes", "Shakespeare", "Dante", "Gabo"], ans: 0 }
            ]
        }
      };

      let state = { 
          lang: 'ES', 
          qIndex: 0, 
          score: 0, 
          isAnswered: false, 
          musicStarted: false,
          timerInterval: null,
          confettiElements: [] 
      };

      AFRAME.registerComponent('game-logic', {
        init: function () {
            this.menuLang = document.querySelector('#menu-idioma');
            this.gameUI = document.querySelector('#ui-juego');
            this.endUI = document.querySelector('#ui-final');
            this.bgMusic = document.querySelector('#bg-music');
            this.soundWin = document.querySelector('#sound-win');
            this.soundFail = document.querySelector('#sound-fail');
            this.timerBar = document.querySelector('#timer-bar');
            this.scene = document.querySelector('a-scene');
            
            this.updateMenuTexts('ES'); 
            
            // Estado inicial visual
            this.gameUI.setAttribute('visible', false); 
            this.gameUI.setAttribute('position', '0 -999 0');
            this.endUI.setAttribute('visible', false); 
            this.endUI.setAttribute('position', '0 -999 0');
            
            this.menuLang.setAttribute('visible', true);
            this.menuLang.setAttribute('position', '0 1.6 -4'); 
            this.menuLang.setAttribute('scale', '0.1 0.1 0.1'); 
            this.menuLang.setAttribute('animation', 'property: scale; to: 1 1 1; dur: 500; easing: easeOutBack');
        },
        
        updateMenuTexts: function(lang) {
            const txts = DATABASE[lang].ui;
            document.querySelector('#txt-bienvenida').setAttribute('troika-text', 'value', txts.bienvenida);
            document.querySelector('#txt-subtitulo').setAttribute('troika-text', 'value', txts.subtitulo);
            document.querySelector('#txt-instr').setAttribute('troika-text', 'value', txts.instr);
            document.querySelector('#txt-btn-es').setAttribute('troika-text', 'value', txts.btn_es);
            document.querySelector('#txt-btn-en').setAttribute('troika-text', 'value', txts.btn_en);
        },

        startMusic: function() {
            if(!state.musicStarted && this.bgMusic && this.bgMusic.components.sound) { 
                this.bgMusic.components.sound.playSound(); 
                state.musicStarted = true; 
            }
        },

        resetGame: function() {
            location.reload(); 
        },

        setLang: function(l) {
            this.startMusic();
            state.lang = l;
            const txts = DATABASE[state.lang].ui;
            document.querySelector('#txt-restart').setAttribute('troika-text', 'value', txts.restart);
            this.transicion(this.menuLang, this.gameUI);
            this.loadQuestion();
        },

        // --- BARRA DE TIEMPO ---
        startTimer: function() {
            this.stopTimer(); 
            let timeLeft = 20;
            const totalWidth = 6; 

            this.timerBar.setAttribute('width', totalWidth);
            this.timerBar.setAttribute('color', '#4CAF50'); 

            state.timerInterval = setInterval(() => {
                if(state.isAnswered) return;
                timeLeft -= 0.1; 
                let pct = Math.max(0, timeLeft / 20); 
                
                this.timerBar.setAttribute('width', totalWidth * pct);

                if(timeLeft > 10) {
                    this.timerBar.setAttribute('color', '#4CAF50'); 
                } else if (timeLeft > 5) {
                    this.timerBar.setAttribute('color', '#FFEB3B'); 
                } else {
                    this.timerBar.setAttribute('color', '#D32F2F'); 
                }

                if(timeLeft <= 0) {
                    this.stopTimer();
                    this.handleTimeout();
                }
            }, 100); 
        },

        stopTimer: function() {
            if(state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
        },

        handleTimeout: function() {
            if(state.isAnswered) return;
            state.isAnswered = true;
            if(this.soundFail) this.soundFail.components.sound.playSound(); 
            const q = DATABASE[state.lang].preguntas[state.qIndex];
            document.querySelector(`#btn-op-${q.ans}`).setAttribute('color', '#4CAF50'); 
            setTimeout(() => { state.qIndex++; this.loadQuestion(); }, 2500);
        },

        loadQuestion: function() {
            state.isAnswered = false;
            this.stopTimer();
            const lista = DATABASE[state.lang].preguntas;
            
            if(state.qIndex >= lista.length) { 
                this.showEndScreen(); 
                return; 
            }
            
            const q = lista[state.qIndex];
            document.querySelector('#txt-contador').setAttribute('troika-text', 'value', `${state.qIndex + 1} / ${lista.length}`);
            document.querySelector('#txt-pregunta').setAttribute('troika-text', 'value', q.q);
            this.startTimer();

            for(let i=0; i<4; i++) {
                let btn = document.querySelector(`#btn-op-${i}`);
                let txt = document.querySelector(`#txt-op-${i}`);
                btn.setAttribute('color', '#B61F25'); 
                btn.setAttribute('scale', '1 1 1'); 
                
                if(i < q.ops.length) {
                    txt.setAttribute('troika-text', 'value', q.ops[i]);
                    btn.classList.add('clickable'); 
                    btn.setAttribute('visible', true);
                    txt.setAttribute('visible', true);
                } else {
                    btn.classList.remove('clickable'); 
                    btn.setAttribute('visible', false);
                    txt.setAttribute('visible', false);
                }
            }
        },

        checkAnswer: function(idx) {
            if(state.isAnswered) return;
            state.isAnswered = true;
            this.stopTimer(); 
            const q = DATABASE[state.lang].preguntas[state.qIndex];
            const btn = document.querySelector(`#btn-op-${idx}`);
            
            if(idx === q.ans) {
                state.score++;
                btn.setAttribute('color', '#4CAF50'); 
                if(this.soundWin) this.soundWin.components.sound.playSound();
            } else {
                btn.setAttribute('color', '#8B0000'); 
                document.querySelector(`#btn-op-${q.ans}`).setAttribute('color', '#4CAF50'); 
                if(this.soundFail) this.soundFail.components.sound.playSound();
            }
            setTimeout(() => { state.qIndex++; this.loadQuestion(); }, 2500);
        },

        // --- CONFETI NATIVO ---
        launchConfetti: function() {
            const colors = ['#FFC107', '#2196F3', '#FF5722', '#4CAF50', '#E91E63'];
            const confettiCount = 60; 

            for (let i = 0; i < confettiCount; i++) {
                let confeti = document.createElement('a-plane');
                let startX = (Math.random() * 8) - 4; 
                let startY = 6 + (Math.random() * 4); 
                let startZ = -4 + (Math.random() * 4); 
                let color = colors[Math.floor(Math.random() * colors.length)];
                
                confeti.setAttribute('color', color);
                confeti.setAttribute('width', '0.08');
                confeti.setAttribute('height', '0.08');
                confeti.setAttribute('side', 'double'); 
                confeti.setAttribute('position', `${startX} ${startY} ${startZ}`);
                
                let duration = 3000 + Math.random() * 2000; 
                
                confeti.setAttribute('animation__fall', {
                    property: 'position',
                    to: `${startX} 0 ${startZ}`,
                    dur: duration,
                    easing: 'linear',
                    loop: true
                });

                confeti.setAttribute('animation__spin', {
                    property: 'rotation',
                    to: `${Math.random()*360} ${Math.random()*360} ${Math.random()*360}`,
                    dur: 2000,
                    easing: 'linear',
                    loop: true
                });

                this.scene.appendChild(confeti);
                state.confettiElements.push(confeti);
            }
        },

        // --- PANTALLA FINAL CON LÓGICA DE MENSAJES ---
        showEndScreen: function() {
            this.stopTimer();
            this.transicion(this.gameUI, this.endUI);
            const total = DATABASE[state.lang].preguntas.length;
            const uiText = DATABASE[state.lang].ui;
            
            let message = "";
            let colorScore = "#FFFFFF";

            // LOGICA DE PUNTAJES
            if (state.score === total) {
                // 10 puntos (Perfecto)
                message = uiText.msg_perfecto;
                colorScore = '#FFD700'; // Dorado
                this.launchConfetti();
            } else if (state.score >= 8) {
                // 8 o 9 puntos
                message = uiText.msg_alto;
                colorScore = '#4CAF50'; // Verde
            } else if (state.score >= 4) {
                // 4 a 7 puntos (Menos de 8)
                message = uiText.msg_medio;
                colorScore = '#FFEB3B'; // Amarillo
            } else {
                // 0 a 3 puntos (Menos de 4)
                message = uiText.msg_bajo;
                colorScore = '#D32F2F'; // Rojo
            }

            const txtFinal = document.querySelector('#txt-score-final');
            const finalString = `${message}\n${state.score} / ${total}`;

            txtFinal.setAttribute('troika-text', {
                value: finalString,
                color: colorScore
            });
            
            // Animación de latido para el texto (para todos los casos, para darle vida)
            txtFinal.setAttribute('animation', {
                property: 'scale',
                from: '1 1 1',
                to: '1.2 1.2 1.2',
                dir: 'alternate',
                dur: 600,
                loop: true,
                easing: 'easeInOutSine'
            });
        },

        transicion: function(salida, entrada) {
            salida.setAttribute('visible', false); 
            salida.setAttribute('position', '0 -999 0');
            entrada.setAttribute('visible', true);
            entrada.setAttribute('position', '0 1.6 -4');
            entrada.setAttribute('scale', '0.1 0.1 0.1');
            entrada.setAttribute('animation', 'property: scale; to: 1 1 1; dur: 500; easing: easeOutBack');
        }
      });

      AFRAME.registerComponent('btn-action', {
        schema: { type: {type:'string'}, val: {type:'string'} },
        init: function() {
            let el = this.el; let data = this.data;
            el.addEventListener('mouseenter', () => {
                if(state.isAnswered && data.type === 'ans') return;
                el.setAttribute('scale', '1.05 1.05 1.05');
                el.setAttribute('material', 'opacity', 0.8);
            });
            el.addEventListener('mouseleave', () => {
                el.setAttribute('scale', '1 1 1');
                el.setAttribute('material', 'opacity', 1.0);
            });
            el.addEventListener('click', () => {
                let logic = document.querySelector('a-scene').components['game-logic'];
                if(data.type === 'lang') logic.setLang(data.val);
                if(data.type === 'ans') logic.checkAnswer(parseInt(data.val));
                if(data.type === 'restart') logic.resetGame();
            });
        }
      });
    </script>
  </head>
  <body>
    <a-scene game-logic cursor="rayOrigin: mouse" raycaster="objects: .clickable">
      <a-assets>
        <img id="fondo360" src="fondo360.jpg">
        <img id="logo" src="ESAN.png">
        <audio id="src-music" src="musica.mp3" loop="true"></audio>
        <audio id="src-win" src="win.mp3"></audio>
        <audio id="src-fail" src="fail.mp3"></audio>

        <a-mixin id="btn-red" geometry="primitive: box; depth: 0.05; height: 0.5; width: 2.5" material="color: #B61F25"></a-mixin>
        <a-mixin id="txt-black" troika-text="align: center; color: #000; fontSize: 0.25; maxWidth: 4.8; outlineWidth: 0.0"></a-mixin>
        <a-mixin id="txt-white" troika-text="align: center; color: #FFF; fontSize: 0.25; maxWidth: 4.5; outlineWidth: 0.0"></a-mixin>
      </a-assets>

      <a-entity id="bg-music" sound="src: #src-music; volume: 1.0; loop: true"></a-entity>
      <a-entity id="sound-win" sound="src: #src-win; volume: 3.0"></a-entity>
      <a-entity id="sound-fail" sound="src: #src-fail; volume: 3.0"></a-entity>

      <a-sky src="#fondo360" radius="60" rotation="0 -90 0"></a-sky>
      <a-light type="directional" position="-1 2 1" intensity="1"></a-light>
      <a-light type="ambient" intensity="1"></a-light>

      <a-entity id="rig">
        <a-camera position="0 1.6 0" look-controls="pointerLockEnabled: false"></a-camera>
        <a-entity hand-controls="hand: right" laser-controls="hand: right" raycaster="objects: .clickable; far: 10; lineColor: #B61F25"></a-entity>
        <a-entity hand-controls="hand: left"></a-entity>
      </a-entity>

      <a-entity id="menu-idioma">
        <a-entity geometry="primitive: plane; width: 5; height: 5.5" 
                  material="color: white; shader: flat" position="0 1.0 -0.1"></a-entity>
        <a-image src="#logo" position="0 2.8 0.1" width="1.8" height="1.8"></a-image>
        <a-entity id="txt-bienvenida" mixin="txt-black" position="0 1.7 0.1" troika-text="value: BIENVENIDO; fontSize: 0.4; color: #B61F25"></a-entity>
        <a-entity id="txt-subtitulo" mixin="txt-black" position="0 1.3 0.1" troika-text="value: SEMANA INTERNACIONAL ESAN"></a-entity>
        <a-entity id="txt-instr" mixin="txt-black" position="0 0.8 0.1" troika-text="value: SELECCIONA TU IDIOMA; color: #555"></a-entity>

        <a-entity position="0 0 0">
            <a-entity class="clickable" btn-action="type: lang; val: ES" mixin="btn-red" position="-1.4 0.2 0">
                <a-entity id="txt-btn-es" mixin="txt-white" position="0 0 0.06" troika-text="value: ESPAÑOL"></a-entity>
            </a-entity>
            <a-entity class="clickable" btn-action="type: lang; val: EN" mixin="btn-red" position="1.4 0.2 0">
                <a-entity id="txt-btn-en" mixin="txt-white" position="0 0 0.06" troika-text="value: ENGLISH"></a-entity>
            </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="ui-juego" visible="false">
        <a-entity position="0 2.2 0">
            <a-entity geometry="primitive: box; width: 2; height: 0.5; depth: 0.05" material="color: #B61F25"></a-entity>
            <a-entity id="txt-contador" mixin="txt-white" position="0 0 0.06" troika-text="value: 1 / 10"></a-entity>
        </a-entity>

        <a-entity geometry="primitive: plane; width: 6; height: 1.5" 
                  material="color: white; shader: flat" position="0 1.2 -0.1"></a-entity>
        <a-entity id="txt-pregunta" mixin="txt-black" position="0 1.2 0.06" troika-text="fontSize: 0.3; value: Cargando..."></a-entity>

        <a-entity position="0 0.3 0">
             <a-box width="6" height="0.15" depth="0.05" color="#333"></a-box>
             <a-box id="timer-bar" width="6" height="0.15" depth="0.06" color="#4CAF50" position="0 0 0.01"></a-box>
        </a-entity>

        <a-entity position="0 -0.8 0">
            <a-entity id="btn-op-0" class="clickable" btn-action="type: ans; val: 0" mixin="btn-red" position="-1.4 0.6 0" width="2.6">
                <a-entity id="txt-op-0" mixin="txt-white" position="0 0 0.06" troika-text="value: A"></a-entity>
            </a-entity>
            <a-entity id="btn-op-1" class="clickable" btn-action="type: ans; val: 1" mixin="btn-red" position="1.4 0.6 0" width="2.6">
                <a-entity id="txt-op-1" mixin="txt-white" position="0 0 0.06" troika-text="value: B"></a-entity>
            </a-entity>
            <a-entity id="btn-op-2" class="clickable" btn-action="type: ans; val: 2" mixin="btn-red" position="-1.4 -0.2 0" width="2.6">
                <a-entity id="txt-op-2" mixin="txt-white" position="0 0 0.06" troika-text="value: C"></a-entity>
            </a-entity>
            <a-entity id="btn-op-3" class="clickable" btn-action="type: ans; val: 3" mixin="btn-red" position="1.4 -0.2 0" width="2.6">
                <a-entity id="txt-op-3" mixin="txt-white" position="0 0 0.06" troika-text="value: D"></a-entity>
            </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="ui-final" visible="false">
        <a-entity geometry="primitive: plane; width: 5; height: 4" 
                  material="color: white; shader: flat" position="0 0.5 -0.1"></a-entity>
        
        <a-entity id="txt-score-final" mixin="txt-black" position="0 0.8 0.1" troika-text="color: #4CAF50; fontSize: 0.6; value: 0 / 10"></a-entity>

        <a-entity position="0 -1.0 0.2"
                  animation="property: scale; to: 1.1 1.1 1.1; dir: alternate; dur: 1000; loop: true">
            
            <a-box class="clickable" btn-action="type: restart; val: 0" 
                   color="#B61F25" width="2.5" height="0.6" depth="0.05"></a-box>
                   
            <a-entity id="txt-restart" mixin="txt-white" position="0 0 0.06" 
                      troika-text="value: VOLVER A JUGAR; fontSize: 0.25"></a-entity>
        </a-entity>

      </a-entity>

    </a-scene>
  </body>
</html>
