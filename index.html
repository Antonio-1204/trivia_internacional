<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>Trivia VR - Versión Final Audio</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>

    <script>
      // ==========================================
      // BASE DE DATOS (CON TILDES Y Ñ)
      // ==========================================
      const DATABASE = {
        'ES': {
            ui: { titulo: "SELECCIONA TU IDIOMA", elige_pais: "TEMÁTICA DE LA TRIVIA", score: "PUNTAJE FINAL:", restart: "VOLVER A JUGAR" },
            paises: { 'PE': 'PERÚ', 'US': 'EE.UU.', 'FR': 'FRANCIA', 'DE': 'ALEMANIA' },
            data: {
                'PE': [
                    { q: "¿Cuál es la capital del Perú?", ops: ["Arequipa", "Lima", "Cusco", "Trujillo"], ans: 1 },
                    { q: "¿Qué animal aparece en el escudo?", ops: ["Llama", "Cóndor", "Vicuña", "Alpaca"], ans: 2 },
                    { q: "¿En qué año se descubrió Machu Picchu?", ops: ["1911", "1900", "1821", "1950"], ans: 0 },
                    { q: "¿Cuál es el río más largo del Perú?", ops: ["Rímac", "Amazonas", "Ucayali", "Marañón"], ans: 2 },
                    { q: "¿Quién es el héroe de Angamos?", ops: ["Bolognesi", "Quiñones", "Grau", "Ugarte"], ans: 2 },
                    { q: "¿Cuál es la moneda oficial?", ops: ["Peso", "Dólar", "Sol", "Inti"], ans: 2 },
                    { q: "¿Dónde está el Lago Titicaca?", ops: ["Puno", "Tacna", "Loreto", "Cusco"], ans: 0 },
                    { q: "¿Plato bandera de pescado crudo?", ops: ["Lomo Saltado", "Ceviche", "Cuy", "Ají de Gallina"], ans: 1 },
                    { q: "¿Cuál es la montaña más alta?", ops: ["Misti", "Huandoy", "Huascarán", "Yerupajá"], ans: 2 },
                    { q: "¿Ciudad conocida como la Ciudad Blanca?", ops: ["Lima", "Trujillo", "Arequipa", "Piura"], ans: 2 }
                ],
                // ... Puedes copiar y pegar la estructura para los otros países
                'US': [ { q: "¿Capital de Estados Unidos?", ops: ["New York", "Washington DC", "Miami", "Los Ángeles"], ans: 1 } ]
            }
        },
        'EN': {
             ui: { titulo: "SELECT LANGUAGE", elige_pais: "TRIVIA TOPIC", score: "FINAL SCORE:", restart: "PLAY AGAIN" },
             paises: { 'PE': 'PERU', 'US': 'USA', 'FR': 'FRANCE', 'DE': 'GERMANY' },
             data: {
                'PE': [{ q: "Capital of Peru?", ops: ["Arequipa", "Lima", "Cusco", "Trujillo"], ans: 1 }]
             }
        }
      };

      let state = {
          lang: 'ES',
          topic: 'PE',
          qIndex: 0,
          score: 0,
          isAnswered: false,
          musicStarted: false
      };

      AFRAME.registerComponent('game-logic', {
        init: function () {
            this.menuLang = document.querySelector('#menu-idioma');
            this.menuTopic = document.querySelector('#menu-tema');
            this.gameUI = document.querySelector('#ui-juego');
            this.endUI = document.querySelector('#ui-final');
            
            // Referencias de Audio
            this.soundWin = document.querySelector('#sound-win');
            this.soundFail = document.querySelector('#sound-fail');
            this.bgMusic = document.querySelector('#bg-music');

            this.resetGame();
        },
        
        startMusic: function() {
            if(!state.musicStarted) {
                this.bgMusic.components.sound.playSound();
                state.musicStarted = true;
            }
        },

        resetGame: function() {
            state.qIndex = 0;
            state.score = 0;
            state.isAnswered = false;
            
            this.ocultarTodo();
            
            // Restaurar menú idioma
            this.menuLang.setAttribute('visible', true);
            this.menuLang.setAttribute('position', '0 1.6 -4');
            this.menuLang.setAttribute('scale', '1 1 1'); // IMPORTANTE: Restaurar escala
        },

        setLang: function(l) {
            this.startMusic(); // Iniciar música al primer toque
            state.lang = l;
            
            const txts = DATABASE[state.lang].ui;
            document.querySelector('#titulo-tema').setAttribute('value', txts.elige_pais);
            document.querySelector('#txt-restart').setAttribute('value', txts.restart);
            
            const p = DATABASE[state.lang].paises;
            document.querySelector('#txt-pe').setAttribute('value', p.PE);
            document.querySelector('#txt-us').setAttribute('value', p.US);
            document.querySelector('#txt-fr').setAttribute('value', p.FR);
            document.querySelector('#txt-de').setAttribute('value', p.DE);

            this.animarCambio(this.menuLang, this.menuTopic);
        },

        setTopic: function(t) {
            state.topic = t;
            if(!DATABASE[state.lang].data[t]) { console.log("Faltan datos, usando default PE"); state.topic = 'PE'; }
            
            this.animarCambio(this.menuTopic, this.gameUI);
            this.loadQuestion();
        },

        loadQuestion: function() {
            state.isAnswered = false;
            const currentData = DATABASE[state.lang].data[state.topic];
            
            if(state.qIndex >= currentData.length || state.qIndex >= 10) {
                this.showEndScreen();
                return;
            }

            const q = currentData[state.qIndex];

            document.querySelector('#txt-contador').setAttribute('value', `${state.qIndex + 1} / 10`);
            document.querySelector('#txt-pregunta').setAttribute('value', q.q);

            for(let i=0; i<4; i++) {
                let btn = document.querySelector(`#btn-op-${i}`);
                let txt = document.querySelector(`#txt-op-${i}`);
                
                // Reset visual
                btn.setAttribute('color', '#1e1e1e');
                btn.setAttribute('scale', '1 1 1');
                
                if(i < q.ops.length) {
                    txt.setAttribute('value', q.ops[i]);
                    btn.classList.add('clickable');
                    btn.setAttribute('visible', true);
                    txt.setAttribute('visible', true);
                } else {
                    btn.classList.remove('clickable');
                    btn.setAttribute('visible', false);
                    txt.setAttribute('visible', false);
                }
            }
        },

        checkAnswer: function(selectedIndex) {
            if(state.isAnswered) return;
            state.isAnswered = true;

            const currentData = DATABASE[state.lang].data[state.topic];
            const q = currentData[state.qIndex];
            const btnSelected = document.querySelector(`#btn-op-${selectedIndex}`);
            
            if(selectedIndex === q.ans) {
                // CORRECTO
                state.score++;
                btnSelected.setAttribute('color', '#4CAF50');
                this.soundWin.components.sound.playSound(); // Sonido Win
            } else {
                // INCORRECTO
                const btnCorrect = document.querySelector(`#btn-op-${q.ans}`);
                btnSelected.setAttribute('color', '#F44336');
                btnCorrect.setAttribute('color', '#4CAF50'); // Mostrar la correcta
                this.soundFail.components.sound.playSound(); // Sonido Fail
            }

            setTimeout(() => {
                state.qIndex++;
                this.loadQuestion();
            }, 2500); // Un poco más de tiempo para ver la respuesta
        },

        showEndScreen: function() {
            this.animarCambio(this.gameUI, this.endUI);
            const txts = DATABASE[state.lang].ui;
            document.querySelector('#txt-score-titulo').setAttribute('value', txts.score);
            document.querySelector('#txt-score-final').setAttribute('value', `${state.score} / 10`);
        },

        animarCambio: function(salida, entrada) {
            salida.setAttribute('visible', false);
            salida.setAttribute('scale', '0 0 0'); // Resetear escala al ocultar
            salida.setAttribute('position', '0 -999 0');
            
            entrada.setAttribute('visible', true);
            entrada.setAttribute('position', '0 1.6 -4');
            entrada.setAttribute('scale', '0.1 0.1 0.1');
            entrada.setAttribute('animation', 'property: scale; to: 1 1 1; dur: 600; easing: easeOutElastic');
        },

        ocultarTodo: function() {
            [this.menuLang, this.menuTopic, this.gameUI, this.endUI].forEach(el => {
                el.setAttribute('visible', false);
                el.setAttribute('position', '0 -999 0');
                el.setAttribute('scale', '0 0 0');
            });
        }
      });

      // COMPONENTE PARA BOTONES
      AFRAME.registerComponent('btn-action', {
        schema: { type: {type:'string'}, val: {type:'string'} },
        init: function() {
            let el = this.el;
            let data = this.data;
            
            el.addEventListener('mouseenter', () => {
                if(state.isAnswered && data.type === 'ans') return;
                el.setAttribute('scale', '1.1 1.1 1.1');
                el.setAttribute('material', 'opacity', 1);
            });
            el.addEventListener('mouseleave', () => {
                el.setAttribute('scale', '1 1 1');
                el.setAttribute('material', 'opacity', 0.6);
            });

            el.addEventListener('click', () => {
                let logic = document.querySelector('a-scene').components['game-logic'];
                if(data.type === 'lang') logic.setLang(data.val);
                if(data.type === 'topic') logic.setTopic(data.val);
                if(data.type === 'ans') logic.checkAnswer(parseInt(data.val));
                if(data.type === 'restart') logic.resetGame();
            });
        }
      });
    </script>
  </head>
  <body>
    <a-scene game-logic cursor="rayOrigin: mouse" raycaster="objects: .clickable">
      
      <a-assets>
        <img id="fondo360" src="fondo360.jpg">
        <img id="logo" src="ESAN.png">
        
        <audio id="music-src" src="musica.mp3" loop="true"></audio>
        <audio id="win-src" src="win.mp3"></audio>
        <audio id="fail-src" src="fail.mp3"></audio>

        <a-mixin id="glass-panel" material="color: #000; opacity: 0.6; transparent: true; metalness: 0.6; roughness: 0.2"></a-mixin>
        <a-mixin id="glass-btn" geometry="primitive: box; depth: 0.05; height: 0.5; width: 2.5"
                 material="color: #1e1e1e; opacity: 0.6; transparent: true"></a-mixin>
        <a-mixin id="font-esp" text="font: roboto; width: 5; align: center; z-offset: 0.06; color: white"></a-mixin>
      </a-assets>

      <a-entity id="bg-music" sound="src: #music-src; volume: 0.3"></a-entity>
      <a-entity id="sound-win" sound="src: #win-src; poolSize: 5; volume: 1"></a-entity>
      <a-entity id="sound-fail" sound="src: #fail-src; poolSize: 5; volume: 1"></a-entity>

      <a-sky src="#fondo360" radius="60" rotation="0 -90 0"></a-sky>
      <a-light type="ambient" intensity="0.5"></a-light>
      <a-light type="spot" position="0 4 2" target="#ui-juego" intensity="0.8"></a-light>

      <a-entity id="rig">
        <a-camera position="0 1.6 0" look-controls="pointerLockEnabled: false"></a-camera>
        <a-entity hand-controls="hand: right" laser-controls="hand: right" raycaster="objects: .clickable; far: 10; lineColor: #B61F25"></a-entity>
        <a-entity hand-controls="hand: left"></a-entity>
      </a-entity>

      <a-entity id="menu-idioma">
        <a-box mixin="glass-panel" width="4" height="3.5" position="0 0.5 -0.1"></a-box>
        <a-image src="#logo" position="0 1.8 0.1" width="1.2" height="1.2"></a-image>
        <a-text value="BIENVENIDO" mixin="font-esp" position="0 1 0.1" font="exo2bold"></a-text>

        <a-entity position="0 0.2 0">
            <a-entity class="clickable" btn-action="type: lang; val: ES" mixin="glass-btn" position="-1.4 0.3 0">
                <a-text value="ESPAÑOL" mixin="font-esp"></a-text>
            </a-entity>
            <a-entity class="clickable" btn-action="type: lang; val: EN" mixin="glass-btn" position="1.4 0.3 0">
                <a-text value="ENGLISH" mixin="font-esp"></a-text>
            </a-entity>
            <a-entity class="clickable" btn-action="type: lang; val: FR" mixin="glass-btn" position="-1.4 -0.4 0">
                <a-text value="FRANÇAIS" mixin="font-esp"></a-text>
            </a-entity>
            <a-entity class="clickable" btn-action="type: lang; val: DE" mixin="glass-btn" position="1.4 -0.4 0">
                <a-text value="DEUTSCH" mixin="font-esp"></a-text>
            </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="menu-tema" visible="false">
        <a-box mixin="glass-panel" width="4" height="3" position="0 0 -0.1"></a-box>
        <a-text id="titulo-tema" value="ELIGE PAÍS" mixin="font-esp" position="0 1.2 0.1" font="exo2bold" color="#B61F25"></a-text>
        
        <a-entity position="0 -0.2 0">
            <a-entity class="clickable" btn-action="type: topic; val: PE" mixin="glass-btn" position="-1.4 0.4 0">
                <a-text id="txt-pe" value="PERÚ" mixin="font-esp"></a-text>
            </a-entity>
            <a-entity class="clickable" btn-action="type: topic; val: US" mixin="glass-btn" position="1.4 0.4 0">
                <a-text id="txt-us" value="EE.UU." mixin="font-esp"></a-text>
            </a-entity>
            <a-entity class="clickable" btn-action="type: topic; val: FR" mixin="glass-btn" position="-1.4 -0.4 0">
                <a-text id="txt-fr" value="FRANCIA" mixin="font-esp"></a-text>
            </a-entity>
            <a-entity class="clickable" btn-action="type: topic; val: DE" mixin="glass-btn" position="1.4 -0.4 0">
                <a-text id="txt-de" value="ALEMANIA" mixin="font-esp"></a-text>
            </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="ui-juego" visible="false">
        <a-entity position="0 2 0">
            <a-box color="#B61F25" width="2" height="0.4" depth="0.1"></a-box>
            <a-text id="txt-contador" value="1 / 10" mixin="font-esp" font="exo2bold"></a-text>
        </a-entity>

        <a-box color="white" width="5.5" height="1" depth="0.1" position="0 1.2 0">
            <a-text id="txt-pregunta" value="..." mixin="font-esp" color="#333" font="roboto"></a-text>
        </a-box>

        <a-entity position="0 -0.5 0">
            <a-entity id="btn-op-0" class="clickable" btn-action="type: ans; val: 0" mixin="glass-btn" position="-1.4 0.6 0" width="2.6">
                <a-text id="txt-op-0" value="Op A" mixin="font-esp" width="4.5"></a-text>
            </a-entity>
            <a-entity id="btn-op-1" class="clickable" btn-action="type: ans; val: 1" mixin="glass-btn" position="1.4 0.6 0" width="2.6">
                <a-text id="txt-op-1" value="Op B" mixin="font-esp" width="4.5"></a-text>
            </a-entity>
            <a-entity id="btn-op-2" class="clickable" btn-action="type: ans; val: 2" mixin="glass-btn" position="-1.4 -0.2 0" width="2.6">
                <a-text id="txt-op-2" value="Op C" mixin="font-esp" width="4.5"></a-text>
            </a-entity>
            <a-entity id="btn-op-3" class="clickable" btn-action="type: ans; val: 3" mixin="glass-btn" position="1.4 -0.2 0" width="2.6">
                <a-text id="txt-op-3" value="Op D" mixin="font-esp" width="4.5"></a-text>
            </a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="ui-final" visible="false">
        <a-box mixin="glass-panel" width="4" height="3" position="0 0.5 -0.1"></a-box>
        <a-text id="txt-score-titulo" value="PUNTAJE FINAL" mixin="font-esp" position="0 1.5 0.1" font="exo2bold"></a-text>
        <a-text id="txt-score-final" value="0 / 10" align="center" position="0 0.5 0.1" width="20" color="#4CAF50" font="exo2bold"></a-text>

        <a-entity class="clickable" btn-action="type: restart; val: 0" position="0 -0.5 0.2">
            <a-cylinder color="#B61F25" height="0.1" radius="0.6" rotation="30 0 0"></a-cylinder>
            <a-text id="txt-restart" value="VOLVER A JUGAR" align="center" position="0 0.05 0.2" rotation="-30 0 0" width="4" font="roboto"></a-text>
        </a-entity>
      </a-entity>

    </a-scene>
  </body>
</html>
